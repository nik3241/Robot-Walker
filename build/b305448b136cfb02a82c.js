"use strict";import*as THREE from"three";import*as CANNON from"cannon-es";import CannonDebugRenderer from"./app/utils/CannonDebugRenderer";import CannonUtils from"./app/utils/cannonUtils";import Stats from"three/addons/libs/stats.module.js";import"./styles/all.css";import{Game}from"./app/Game";import{Terrain}from"./app/objects/Terrain";import{BotModel}from"./app/objects/Bot/BotModel";import{OrbitControls}from"three/examples/jsm/Addons.js";import{GameCamera}from"./app/objects/GameCamera";import{LowPolyTrees}from"./app/objects/Trees/LowPolyTrees";const _DEBUG=!0;async function main(){const e=document.getElementById("game"),o=new Game(e);let n;const a=o.phisicsWorld;window.myGame=o;const t=new Stats;t.domElement.style="position: absolute; top: 3px; left: 3px; cursor: pointer; opacity: 0.9; z-index: 10000;",console.log(),e.children[0].appendChild(t.domElement);const d=o.gui.addFolder("General"),r=o.gui.addFolder("Helpers").close(),s=o.gui.addFolder("Objects"),i=o.gui.addFolder("Lights").close();o.displayMenuStart(),function(){const e=o.phisicsWorld.gravity,t=o.gui.addFolder("Physics");t.add(e,"x",-10,10,.1),t.add(e,"y",-10,10,.1),t.add(e,"z",-10,10,.1),t.open(),n=new CannonDebugRenderer(o.scene,a)}(),o.camera.position.set(0,0,0),o.camera.rotation.set(0,0,0),d.reset().add(o,"statisticsVisible").onChange((()=>{o.toggleStatistics(),H(o.camera)})),o.lights.children.forEach(((e,o)=>{const n=i.addFolder(e.type+o);n.add(e,"intensity").name("intensity").step(.01),n.addColor(e,"color",255)})),o.helpers.add(new THREE.PointLightHelper(o.scene.children[0].children[1],5)),o.helpers.add(new THREE.PointLightHelper(o.scene.children[0].children[2],5)),o.helpers.add(new THREE.AxesHelper),o.helpers.add(new THREE.GridHelper(10,10,505418,9963445)),r.add(o.helpers,"visible").name("Отображение помощников"),r.close(),o.helpers.children.forEach((e=>{r.add(e,"visible").name(e.type)}));const l=new Terrain(500,500,16);await l.__init__(),l.visible=!1,s.add(l,"visible").name("Земля"),o.objects.add(l);const c=new BotModel(o);o.objects.add(c),await c.loadModel(),d.add(c.position,"x"),d.add(c.position,"y"),d.add(c.position,"z"),d.add(c.rotation,"x"),d.add(c.rotation,"y"),d.add(c.rotation,"z"),s.add(c,"visible").name("робот"),c.add(new THREE.AxesHelper(3)).add(o.lights.children.at(-1)),o.controls.push(c.controls),o.addPhisicsBody(c.body,"bot");const m=function(){const e=(new THREE.TextureLoader).setPath("/").load("grass.png"),o=new THREE.PlaneGeometry(250,250,10,10),n=new THREE.MeshStandardMaterial({color:15658734,map:e,metalness:1});n.map.repeat.set(40,40),n.map.wrapS=n.map.wrapT=THREE.RepeatWrapping;const a=new THREE.Mesh(o,n);return a.name="Plane",a.receiveShadow=!0,a}();s.add(m,"visible").name("Плоскость"),o.objects.add(m);var h=function(e){var o=new CANNON.Body({mass:0}),n=new CANNON.Plane;return o.addShape(n),o.quaternion.setFromEuler(-Math.PI/2,0,0),o.position.y=-.2,e.position.copy(o.position),e.quaternion.copy(o.quaternion),o}(m);a.addBody(h),N(m,h);const p=new LowPolyTrees,w=new THREE.Group;o.objects.add(w);for(let e=0;e<15;e++)w.add(p.getTree("",new THREE.Vector3(p._getRandomArbitrary(0,45),0,p._getRandomArbitrary(0,45))));const E=function(e=5){const n=[],t=new THREE.MeshStandardMaterial({color:16777215*Math.random(),flatShading:!0,name:"Box_mtl"});for(let d=0;d<e;d++){const e=new CANNON.Vec3(2*Math.random(),2*Math.random(),2*Math.random()),d=new CANNON.Box(e),r=new THREE.BoxGeometry(2*e.x,2*e.y,2*e.z),s=20*(Math.random()-.5),i=2*e.y+20*Math.random(),l=20*(Math.random()-.5),c=new CANNON.Body({mass:1});c.addShape(d),c.position.set(s,i,l),a.addBody(c);const m=new THREE.Mesh(r,t);o.scene.add(m),m.castShadow=!0,m.receiveShadow=!0,n.push({mesh:m,body:c})}return n}(),u=function(e=5){const n=[],t=new THREE.MeshStandardMaterial({color:16777215*Math.random(),flatShading:!0,name:"Icosahedron_mtl"});for(let d=0;d<e;d++){const e=new THREE.IcosahedronGeometry(.5+3*Math.random(),0),d=CannonUtils.CreateConvexPolyhedron(e),r=20*(Math.random()-.5)-10,s=8*Math.random(),i=20*(Math.random()-.5)-10,l=new CANNON.Body({mass:.5+5*Math.random()});l.addShape(d),l.position.set(r,s,i),a.addBody(l);const c=new THREE.Mesh(e,t);o.scene.add(c),c.castShadow=!0,c.receiveShadow=!0,n.push({mesh:c,body:l})}return n}(),y=function(e=5){const n=[],t=new THREE.MeshStandardMaterial({color:16777215*Math.random(),flatShading:!0,name:"TorusKnot_mtl"});for(let d=0;d<e;d++){const e=.5+3*Math.random(),d=new THREE.TorusKnotGeometry(e,.1*e,32,6),r=CannonUtils.CreateTrimesh(d),s=20*(Math.random()-.5)-10,i=8*Math.random(),l=20*(Math.random()-.5)-10,c=new CANNON.Body({mass:.5});c.addShape(r),c.position.set(s,i,l),a.addBody(c);const m=new THREE.Mesh(d,t);o.scene.add(m),m.castShadow=!0,m.receiveShadow=!0,n.push({mesh:m,body:c})}return n}(0),M=new CANNON.Body({mass:1,shape:new CANNON.Box(new CANNON.Vec3(1,1,1))});a.addBody(M),M.position.set(0,2.5,4),console.log("кубик физическое тело",M);const g=new THREE.BoxGeometry(2,2,2),T=new THREE.MeshStandardMaterial({color:16777215*Math.random(),flatShading:!0,name:"Cube_mtl"}),b=new THREE.Mesh(g,T);b.name="Cube",b.castShadow=!0,o.scene.add(b),console.warn(a),s.add(b,"visible").name("Куб");const f=new THREE.AxesHelper(10);function H(){let e=o.canvas.parentNode;console.log(this),console.log(o.camera),o.camera.aspect=e.clientWidth/e.clientHeight,o.camera.updateProjectionMatrix(),o.renderer.setSize(e.clientWidth,e.clientHeight,!1),o.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2))}function N(e,o){e.position.set(o.position.x,o.position.y,o.position.z),e.quaternion.set(o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w)}f.name="boxLocalAxis",b.add(f),o.renderer.setAnimationLoop((function(){const e=o.clock.getDelta();c.update(e),N(b,M);for(let e=0;e<E.length;e++)N(E[e].mesh,E[e].body);for(let e=0;e<u.length;e++)N(u[e].mesh,u[e].body);for(let e=0;e<y.length;e++)N(y[e].mesh,y[e].body);a.step(e),n.update(),t.update(),o.renderer.render(o.scene,o.camera)})),H(o.camera),console.log(n),window.addEventListener("resize",H),o.canvas.addEventListener("dblclick",(e=>{e.target===o.canvas&&(document.fullscreenElement?(document.exitFullscreen(),H()):(o.canvas.requestFullscreen(),H()))}))}document.addEventListener("DOMContentLoaded",main);